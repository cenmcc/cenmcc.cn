# 第三章 网络协议和体系结构



#### 网络协议

- 概念：网络协议就是 通信双方必须遵守的规则和约定称为协议或规程。<u>协议的要素包括**语法、语义和时序关系**</u>
- 分层的思想：**分层的核心思路是上一层的功能建立在下一层的功能基础上， 并且在每一层内均要遵守一定的通信规则。**
- 分层的好处：
  1. 各层次之间可相互独立
  2. 有较强的灵活性
  3. 分层的思想有利于标准化
- **网络体系结构**：**层次**和**协议**的集合构成了网络的**体系结构**。体系结构研究的是网络系统各部分的组成及其相互关系。**目前，典型的层次化体系结构有OSI参考模型和TCP/IP参考模型两种。**



#### OSI参考模型

- 概念：1984年，负责制定国际标准的国际标准化组织ISO吸取了IBM的SNA和其他计算机厂商的网络体系结构，提出了开放系统互连（Open System Interconnection）参考模型（OSI/RM），简称OSI模型。“**开放**”，是指按照这个标准设计和建成的数据信网中的设备都可以相互通信。

- **各层的功能**：OSI参考模型采用分层结构化技术，将整个网络通信分为7层。

  由低层至高层分别如下：

  1. **物理层**：实现比特流传输，实现信号编码功能；规定数据终端设备DTE与数据通信设备DCE的接口特性。包括机械、 电气、功能和规程四个方面。
  2. **数据链路层**：传输以“帧”为单位的数据块，进行差错控制、 连接管理等功能。
  3. **网络层**：数据转发和路由、流量控制、寻址（IP地址）。
  4. **传输层**：端到端通信（进程-进程）
  5. **会话层**：用户和用户的连接、通过在两台计算机间建立、管理和终止通信完成对话。实际应用中已被应用层覆盖。
  6. **表示层**：主要处理应用实体间交换数据的语法，解决格式和数据表示的差异，为应用层提供统一的数据格式。还可以实现压缩（解压缩），加密（解密），字符编码的转换功能。实际中，该层功能由应用层实现，不单独存在。
  7. **应用层**：提供给用户相关的网络服务接口。

- **OSI参考模型有关的术语**

  - **数据单元**：在层的实体之间传送的比特组称为数据单元。在对等层之间传送数据单元是按照本层协议进行的，这时的数据单元称为协议数据单元PDU。PDU在不同层往往有不同的叫法，如在物理层中称为位流或比特流，在数据链路层中称为帧，在网络层中称为分组或包，在传输层中称为数据段或报文段，以及在应用层中称为报文等。
  - **服务访问点**：相邻层间的服务是通过其接口面上的服务访问点SAP进行的 N层SAP就是（N+1）层可以访问N层的地方。每个SAP都有唯一的一个地址。 
  - **服务原语**：OSI参考模型的原语有4类
    1. 请求（Request）
    2. 指示（Indication）
    3. 响应（Response） 
    4. 确认（Confirm）
  - **面向连接和无连接**
    1. 面向连接服务：需要请求建立连接、连接建立、传输数据、 拆除链路的过程。如果接收方收到数据后予以确认，就是可靠传输；不确认，就是不可靠传输方式
    2. 无连接服务就是没有链路建立和拆除的过程。每个分组独立选择路径，无序、接收方需要重组分组。

- 路由器转发的是IP分组，在网络层。交换机转发的是帧，在数据链路层



#### TCP/IP参考模型

- 产生

  1. 1970年，网络控制协议NCP产生。
  2. 1974年，TCP详细说明正式发表。
  3. 1978年，TCP正式变为TCP/IP，TCP负责可靠传输。IP负责寻址转发。
  4. 1983年，NCP停用，<u>TCP/IP作为互联网上标准协议</u>

- TCP/IP参考模型的功能

  1. **网络接口层**（对应OSI：物理层、数据链路层）：本层的具体实现方法随着网络类型不同而不同，允许使用广域网、局域网与城域网的各种协议。只要遵循网络互联层的IP协议即可。这一层包括OSI参考模型中的数据链路层和物理层。

  2. **网络互联层**（对应OSI：网络层）：该层协议主要是IP协议，一种不可靠、无连接的数据报传送服务协议。本层的协议数据单元是**IP分组**。该层设备是路由器， 路由转发，IP分组寻址。**网络互联层还包括互联网控制报文协议（ICMP）、互联网多播组管理协议（IGMP）**，以及路由协议，如BGP、OSPF、IP、ARP、RARP和RIP等。

  3. **传输层**（对应OSI：传输层）：负责在会话进程之间建立和维护**端-端（进程-进程）**连接，实现网络环境中分布式进程通信。

     传输层主要包括<u>面向连接、提供可靠数据流传输的传输控制协议（TCP）</u>和<u>无连接、不提供可靠数据传输的用户数据报协议( UDP )</u>。TCP协议提供比较完善的流量控制与拥塞控制功能。

  4. **应用层**（对应OSI：会话层、表示层、应用层）：Internet上常见的应用大多在这一层，用户通过应用层来使用 Internet提供的相应服务。TCP/IP应用层基本的协议主要是：

     - 远程登录协议（TELNET）

     - 文件传输协议（FTP）

     - 简单邮件传输协议（SMTP）、POP3协议

     - 超文本传输协议（HTTP）

     - 域名服务（DNS）协议

     - 简单网络管理协议（SNMP）

     - 动态主机配置协议（DHCP）

- **通讯过程**：在实际的数据通信过程中，用户的数据在应用层以报文的形式开始向下一层进行封装，形成段、数据报、帧，最后以比特流的形式在不同的传输介质上进行传输。

- **与OSI参考模型的区别**：

  TCP/IP参考模型与OSI参考模型有很多相似之处，都是按照分层的思想对计算机网络进行模块化设计，形成了一组自上而下的单向依赖关系的协议栈，两者的主要区别是：

  1. **层次划分的不同**
  2. **面向连接的和面向无连接的通信的不同**
  3. **与具体协议的配合程度**



### TCP/IP参考模型中的传输层

- 传输层的主要功能：
  1. 为应用进程之间提供端端的逻辑通信， 传输层通常还对收到的报文进行差错检测；
  2. 某些传输层协议进行端道端的数据传输可控性控制；
  3. 传输层协议要针对应用层实现负用于解负用的功能等
- TCP/IP的传输层协议：
  - 面向连接的传输控制协议（TCP）
  - 无连接的用户数据报协议（UDP）
- 传输层的通信： 传输成为了支持运行在不同主机、 不同操作系统上的应用进程之间能够相互通信， 必须用统一的选举方法，对TCP/IP体系的应用进程进行标识。 解决方法就是在传输层使用协议端口号或简称为端口。 在TCP/IP 中， 是通过IP地址加端口号来 标识通信中的端点， 其中， IP地址用于标识网络中的主机， 而端口号用于识别是哪一个服务或应用进程。
  - 传输层使用协议端口号，简称为端口（Port）进行统一寻址。
  - 端口号是一个16位的二进制整数，根据端口号的大小，端可以分为熟知端口、注册端口和客户端口等。
  - 端口号**0~1023是熟知端口**如： ftp (20， 21) ， smtp （25) ， http ( 80 ) 、**1024~49151为登记端口**（需要登记备案的端口）、**49152~65535为客户端口**（进程端口）

#### UDP

- **定义**：用户数据报协议（UDP），是一种无连接的传输层协议。

- UDP首部构成：源端口号、目的端口号、长度和检验和字段。

  ```
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
  |     源端口号 (2)      |    目的端口号(2)   |    长度(2)    |			校验和(2)		｜
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
  ```

- UDP首部共8个字节，开销小。

- 长度：包括首部和数据部分的总字节数。

- **UDP的工作机制主要包括以下几个方面：**
  
  1. UDP是一个无连接协议，传输数据之前源端和终端不建立连接。
  2. 一台服务机可同时向多个客户机传输相同的消息。
  3. UDP数据报的首部很短，只有8个字节。
  4. 吞吐量不受拥塞控制算法的调节。
  5. UDP使用最大能力交付，即不保证可靠交付。
  6. UDP是面向报文的，对报文不拆分、不合并。适用于实时性要求高的场合。

1字节 = 8位

#### TCP

- **定义**：TCP（传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。由IETF的RFC793定义。在TCP/IP参考模型中，TCP位于网络互联层之上，应用层之下。由于IP层不提供可靠的通信服务，因此主机之间要实现可靠的数据传输，需要使用TCP的传输控制。
  1. 应用层向TCP层发送用于网间传输的、用字节标识的数据流，然后TCP把数据流分成适当长度的报文段（注：长度受数据链路层的最大传输单元MTU限制，以太网的MTU是1500字节）
  2. TCP把结果数据报传给网络互联层的IP，由它来通过网络将数据报传送给接收端实体的TCP。（TCP为了保证不发生数据报丢失，就给每个数据报一个序号）
  3. 接收端实体对已成功收到的数据报发回一个相应的确认（ACK）
  4. 如果发送端实体在合理的往返时延（RTT）内未收到确认，那么对应的数据报就被假设为已丢失，将会被重传。
  
- TCP首部结构：
  
  ![](https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2022%2F0621%2F7fa82776j00rdtbzl002nc000k000cim.jpg&thumbnail=660x2147483647&quality=80&type=jpg)
  
  - **源端口和目的端口**：分别占16位， 标识发送该数据报的源端口和目的端口。
  - **序号和确认序号**：分别占32位， TCP的序号是对每个应用层数据的每个字节进行编号， 因此每个TCP段的序号是该段所封装的应用层数据的第一个字节的序号。 确认序号是期望从对方接收数据的字节序号，即该序号对应的字节尚未收到， 该序号之前的字节已被全部正确接收， 也就是说TCP采用累积确认机制。
  - **数据偏移**： 占4位， 指出TCP段的首部长度，以4B为计算单位
  - **保留**：占6位，保留为今后使用，目前为0
  - **URG、ACK、PSH、PST、SYN和FIN字段**：各占1位，共占6位。
    - <u>URG=1：表明由紧急数据，应尽快送达</u>
    - <u>ACK：标识确认号字段是否有效 1:有效 0:无效</u>
    - <u>PSH=1：标识应尽快交付接收应用进程，而不再等到整个缓存填满后在交付</u>
    - <u>RST=1：TCP连接中出现严重差错，需释放重连</u>
    - <u>SYN=1：表明这是一个建立新连接请求控制段或者是同意建立新连接的确认段</u>
    - <u>FIN：用来释放TCP连接 1:表明该TCP段的发送端的数据以发送完毕，并请求释放TCP连接</u>
  - **窗口字段**：占16位， 用于向对方通过接收窗口大小（单位为字节）， 旗帜是本段接收对方数据的缓存剩余空间用于实现TCP的流量控制
  - **校验和字段**：占16位， 校验和字段校验的范围类似于UDP，包括了TCP首部和应用层数据。
  - **紧急指针字段**：占16位， 指出在本报文段中紧急数据共有多少个字节
  - **选项字段（长度可变）**
  - **填充字段**：长度为0～3个字节，取值为0
  
- TCP连接管理：TCP连接管理包括**连接建立**、**数据传输**和**连接拆除**三个阶段

- **TCP的连接建立（三次握手）**：
  
  1. A的TCP向B发出连接请求报文段
  2. B的TCP收到连接请求报文段后，如同意，则发回确认。
  3. A收到此确认报文段后向B给出确认
  
- **TCP的连接拆除（四次握手）**：
  
  1. TCP通信的双方都可以拆除连接，假设拆除连接由A发，起则A向B发送释放连接控制报文段，并停止再发送数据。
  2. B收到A发出的释放连接控制报文段后，立即向A发送确认报文段。A收到来自B的确认后，进入等待状态，等待B发出的释放连接控制报文段。
  3. 如果B已经没有要向A发送的数据，则B向A发送释放连接控制报文段
  4. A收到B的释放连接控制报文段后，要向B发送确认报文段。 B收到该确认报文段后，可以马上释放连接。 A在发出该确认段后，延迟一段时间即释放链接。
  
- **流量控制**：流量控制的目的是使发送端的数据发送速率不要太快，确保接收端能够来得及接收，即接收端的数据缓存不会溢出。

- **拥塞控制**：TCP的拥塞控制机制是从端到端的角度推测网络是否发送拥塞，如果推断网络发送拥塞，则立即将数据发送速率降下来，以便缓解网络拥塞。采用的是窗口机制

- 快重传算法：1990年在此基础上又增加了**快速重传**和**快速恢复**两个算法。快重传算法规定，发送端只要一连收到三个重复的ACK即可定有分组丢失了，就应立即重传丢失的报文段而不必继续等待为该报文段设置的重传计时器的超时。

