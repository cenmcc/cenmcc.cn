# 第五章 网络互联技术

### 网络互联

- 概念：网络互联技术是所有能在物理上和逻辑上实现不同网络相互连接的技术的总称，对应于ISO/OSI模型的各个层次。**“互联”**和**“互连”**具有不同的含义：“网络互连”仅指将网络通过有线或无线传输介质在物理上连接在一起，而“网络互联”的含义还包括不同的网络之间在功能和应用上能够看起来像一个完整的网络一样，自由顺畅地运行。
- 异构网络定义：采用不同**通信技术**和**运行协议**的网络通常称为异构网络

#### 网际协议（IP）

- 网络互联层协议（ISO/OSI参考模型网络层）：

  1. **地址解析协议ARP**（IP转换为MAC地址）
  2. **RARP（MAC转换为IP地址）**
  3. **网际控制报文协议ICMP**（ping）
  4. **网际组管理协议IGMP**
  5. **网际协议IP**

- IP网络采用**路由器（Router）**作为网络互联的中间设备，将不同的计算机网络连接在一起，在**网络层**实现数据的路由和转发。

- **IP的特点如下：**

  1. IP是面向无连接的、不可靠的分组传输协议

  2. IP屏蔽了数据链路层和物理层的差异，使得数据的传输和转发更加方便

  3. IP是**点对点式网络通信协议**

- IPv4协议报文格式（第4版IP协议）

  ![](https://download.huawei.com/mdl/image/download?uuid=446deff1b29d428b900af1d22fc02a47)
  
  - 版本号：4位，表示IP的版本
  - 首部长度：4位，给出的是IP分组首部长度，包含可变长度的选项字段，以4B位单位，4个比特可表示的最大数值是15，，最大值是60个字节
  - 区分服务字段：8位，指示期望获得那种类型的服务
  - 总长度字段：16位，给出IP分组的总字节书，包含首部和数据部分。
  - 标识字段：16位，用于标识一个IP分组。
  - 标识位字段：3位，最高比特位保留，DF是禁止分片标识，MF是更多分片标识。
  - 片偏移字段：13位，标识一个IP分组分片封装源IP分组数据的相对偏移量。单位8B
  - 生存时间（TTL）：占8位，标识IP分组在网络中可以通过的路由器数
  - 协议字段：占8位，指示该IP分组封装的是哪个协议的数据包
  - 首部校验和：占16位，利用校验和实现对IP分组首部的差错检测。
  - 源IP地址：占32位，是发出IP分组的源主机的IP地址
  - 目的IP地址：是IP分组需要送达的主机的IP地址
  - 选项字段：长度可变，携带安全、源选路径、时间戳和路由记录等内容
  - 填充字段：长度可变，目的是补齐整个首部

### IP地址

- 目前普遍使用的IP地址是IPv4，用32位二进制表示。32bit分为4组，每组转化为十进制，用"."隔开，这种表示方法称为**点分十进制法**。

- IP地址的转换：

  比如某IP地址用二进制数表示为 11001010 11000010 00010100 10001010

  用点分十进制数就可以写成 202.194.20.138 **技巧：138=128+8+2**

  | 1    | 1    | 1    | 1    | 1    | 1    | 1    | 1    |
  | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
  | 128  | 64   | 32   | 16   | 8    | 4    | 2    | 1    |

- IP地址的分类：

  IP地址::={<网络号>，<主机号>}

  不同的网络号和主机号的设置决定了IP地址的分类，包括了 A，B，C，D和E共5种类别。 

  - A类地址：网络号占8位(1个字节)，主机号占24位(3个字节)，其网络号最高固定位1。（0.0.0.0 ~ 127.255.255.255）16777214
  - B类地址：网络号占16位(2个字节)，主机号占16位(2个字节)，其中网络号最高两位固定位10。（128.0.0.0 ~ 191.255.255.255）65534
  - C类地址：网络号占24位(3个字节)，主机号占8位(1个字节)，其中网络号最高3位固定位110。（192.0.0.0 ~ 223.255.255.255）254
  - D类地址：最高4位为1110，用于IP多播。（224.0.0.0 ~ 239.255.255.255）
  - E类地址：最高4位为1111，作为保留使用。（240.0.0.0 ~ 255.255.255.255）

- **子网划分**

  - 概念：划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。

    从**主机号**借用若干个比特作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个比特。

    IP地址::{<网络号>，**＜子网号>**，<主机号>}

  - 子网划分的好处：

    1. **避免IP资源浪费**
    2. **增加灵活性**

  - 子网划分举例:

    某单位拥有一个C类地址，其网络地址为202.194.20.0（网络号为202.194.20），则所有目的IP地址为202.194.20.x的IP数据报都会被送到与这个网络相连的路由器R上。

    假设该单位将其主机号中的3位作为子网号使用，剩下的5位作为主机号，则可以最多在其单位内部划分出8个子网。（每个子网可以容纳30个主机）

    202.194.20.**XXX**XXXXX

    子网号：000,001,010,011,100,101,110,111

    主机号：以000子网为例：00000-11111

    202.194.20.1 ~ 202.194.20.30

  - **子网掩码**

    - 子网划分的核心问题：如何使得路由器能够正确地将IP数据报发送给网络内部不同的子网（采用子网掩码）

    - 概念：子网掩码也是一个32位的二进制数，由一串1和跟随的一串0 组成，形如11111111 11111000 00000000 00000000，与IP 地址一样，也可以用4个点分十进制数来表示。**子网掩码中的 1对应于IP地址中的网络号和子网号字段，0对应于主机号字**

    - 子网掩码的使用：子网掩码与目的IP地址配合起来，可知道该IP地址所在子网的网络地址，具体的方式是**将IP地址与子网掩码按位进行逻辑与 （AND）运算**，其结果即为所在子网的网络地址。

      【举例】IP地址202.194.20.138，其子网掩码为 255.255.255.224（ 11111111 11111111 11111111 11100000），两者按位进行逻辑与运算为：

      逻辑运算

      11001010	11000010	00010100	10001010（202.194.20.138）

      11111111	11111111	11111111	11100000（255.255.255.224）

      ——————————————————————————

      11001010	11000010	00010100	10000000（202.194.20.128）

      有0则为0，否则为1

    - 如果内部网络没有进行子网划分，即子网掩码中1的位置与 IP地址网络号字段相对应。

      - A类IP地址的默认子网掩码为**255.0.0.0**

      - B类IP地址的默认子网掩码为**255.255.0.0**
      - C类IP地址的默认子网掩码为**255.255.255.0**

  - **无分类编址CIDR**

    - 概念：CIDR不再按照A，B，C类的类型区分IP地址。它把32位的IP地址划分为两部分，前面的部分称为网络前缀，用来指明网络，后面的部分用来指明主机。这是一种无分类的两级编址表示方法如下。

      **IP地址:: = {＜网络前缀>，<主机号>}**

      举例：202.194.20.138/27（27表示前27个bit表示网络前缀，后5个bit表示主机号）（主机号不能全0或者全1）

    CIDR 将网络前缀都相同的连续的IP 地址组成“CIDR地址块”。
    
    202.194.20.138/27
    
    为了描述方便，通常用CIDR地址块中的最小地址和网络前缀位数来指明地址块，则上面所表示的IP地址块就可以写为
    
    202.194.20.128/27
    
    ————————————————————————
    
    11001010	11000010	00010100	100-00000
    
    202 .		194.			20.		128
    
    11001010	11000010	00010100	100-11111
    
    202 . 		194.			20.		159
    
    可分配 129 - 158
    
  - 网络前缀位数即为地址掩码中1的个数，地址掩码的其余位为0。
  
    例如“/27“对应的子网掩码为11111111 11111111
  
    11111111 11100000（255.255.255.224）
  
    无分类的地址，可以减少路由表条目（路由聚合）
  
    划分子网：地址块大小相等（**先确定子网号，主机位数都一样**）
  
    和地址块大小不等（**先划分地址数多的地址块，先确定主机号所占的位数，再确定子网号**）。
  
  - 最长前缀匹配：在路由聚集过程中，可能存在将一个聚集在一起的大子网中的某个（或某几个）小子网单独分出去，就会导致大子网不包含这些小子网的现象。为了充分利用路由聚集带来的高效路由的好处， 又需要避免出现路由错误，可以在同一个路由器中并列关于到达大子网和小子网的路由。小子网的网络前缀比大子网的网络前缀要长。在这种情况下，在使用CIDR进行路由查找时，有可能会得到不止一个的匹配结果，这时，应当从匹配结果中选择具有最长网络前缀的路由，**称为最长前缀匹配**。因为网络前缀越长，子网就越小，路由就越具体。
  
  - 私有IP地址：
  
    在IP地址中特别划分出一部分地址作为保留使用，称为私有地址或专用地址。这部分地址可以在某个网络内部使用，形成一个专用网，但不能在公共互联网上使用，公共互联网会丢弃目的地址是这部分地址的IP分组。
  
    - 10.0.0.0--10.255.255.255.255
    - 172.16.0.0--172.31.255.255
    - 192.168.0.0--192.168.255.255
  
- NAT网络地址转换

  - 网络地址转换NAT方法于1994年提出。
  - 需要在专用网连接到因特网的路由器上安装 NAT软件。装有 NAT 软件的路由器叫做 NAT路由器，它至少有一个有效的外部全球地址IPg。
  - 所有使用本地地址的主机在和外界通信时都要在 NAT 路由器上将其本地地址转换成 IPg。才能和因特网连接。





### IP路由

- 概念：当Internet中的每一个参与通信的设备都被赋予有效的IP地址之后，IP数据报就可以按照IP地址进行发送和接收，而在整个网络中为IP数据报寻找合适的通信路径并且将其转发出去的过程称为IP路由，是由路由器实现的。

- 路由器

  - 功能：路由器是一种具有多个输人端口和多个输出端口的专用计算机， 其主要任务是获取与维护路由信息及转发分组。（“路由” 与“转发”是路由器最重要的两项基本功能。）

  - 结构：路由器从功能结构角度可以分为：**输人端口、输出端口、交换结构与路由处理器。**

  - 转发方式：通过静态（人工方式）或者动态（运行路由协议）获取的路由信息被保存在路由表中，供数据转发时使用。

  - 路由表的基本结构

    | 目的网络 | 子网掩码 | 下一跳 | 接口 |
    | -------- | -------- | ------ | ---- |

    - 目的网络与子网掩码：准确描述了一个目的的网络
    - 下一跳：表示到达该目的网络的路径的下一个邻居结点的接口IP地址
    - 接口：是转发IP分组到该目的网络时，应从哪个接口将IP分组转发出去

  - 工作过程：收到IP分组，查找路由器，转发IP分组，若多个路由条目匹配，则选择网络前缀最长的路由项

- 路由算法：

  1. **静态路由与动态路由**：人工配置的路由；根据某种路由算法得到的路由信息
  2. **距离-向量路由算法**：周期性的向邻居通告本路由信息，邻居根据通告更新自己的路由表信息并与其相邻的邻居交换路由信息
  3. **链路状态路由算法**：每个路由器根据其链路状态，依据Dijkstra算法求出到达每个网络的**最短路径**。
  4. **层次路由**：AS内部采用相同的路由协议，AS之间采用自治系统间距路由协议。

- 路由协议：

  1. 自治系统：自治系统是统一技术管理下的一组路由器。
  2. 域内路由与域间路由：
     - 内部网关协议IGP：RIP，OSPF
     - 外部网关协议EGP：BGP4
       - RIP路由协议：距离向量的IGP，直连网络的跳数为1，每经过由器跳数+1，最大15跳（16跳表示网络不可达）。
       - OSPF路由协议：开放最短路径优先协议，区概念（主干区域0.0.0.0）
       - BGP协议：不同自治系统的路由器交换路由信息的协议。

#### IP中的其他协议

- **地址解析协议（ARP）**：<u>将IP地址转换为MAC地址</u>
  - ARP的基本思想是在每一台主机中设置专用内存区域，称为ARP高速缓存（命令：arp-a），里面有该主机所在局域网中各个主机和路由器的IP地址与硬件地址(MAC)的映射表，并且这个映射表要经常更新。
  - 假设某局域网中的主机A要向局域网内的另一个主机B发送IP数据报， 主机A首先查找其ARP高速缓存内的映射表中是否有主机B的IP地址， 如果有，则查找出其对应的硬件地址，并将该硬件地址写人MAC帧， 通过局域网将该MAC帧发送给主机B。如果ARP高速缓存中没有主机 B的IP地址，则运行ARP，找出主机B的硬件地址。
  - 过程：我的IP地址和mac地址是多少，我想知道IP地址是a的mac地址。。。
- **动态主机配置协议（DHCP）**应用层：<u>动态配置主机IP地址</u>
  - DHCP采用的是客户机/服务器务器模式。
  - **基本思想**：在一个网络内部设置一台DHCP服务器，其中保存和管理着该网络所管辖的IP地址及其他配置信息。当一台计算机新接人该网络时，还没有配置IP地址，它在开机启动后向该网络广播发送一个DHCP发现报文， DHCP服务器在收到这个DHCP发现报文后，从自己所保存的IP地址数据库中取出一个IP，与其他配置信息一起，通过DHCP提供报文发送给这台计算机，从而为这台计算机分配一个新的IP地址及其他配置信息。
- **网际控制报文协议ICMP**
  - 概念：数据报在传输过程中出现延迟、丢失等异常情况，如果通信的双方能够知道这些异常情况，就可以及时地进行调整和控制， 提高网络传输的效率和成功率。网际控制报文协议（ICMP）就是用来完成这一功能的机制。
  - ICMP报文有两种类型**：ICMP差错报告报文**和**ICMP询问报文**。
    - 差错报告报文的五种情况：终点不可达、源点抑制、时间超时、参数问题、改变路由。
    - 询问报文：回送请求和回答（**ping**）、时间戳请求和回答
- **网际组管理协议（IGMP）**
  - 概念：IGMP是网络层协议，用于对IP多播提供管理服务。IP多播 （Multicast）也称为IP组播，是针对Internet上许多由一个源点向多个终点发送数据的业务而设计的一种服务比如新闻发布、 视频点播和视频会议等业务，都是由一个信息源点向多个用户传递信息的Internet应用。
  - 基本思想：利用多播IP地址标识一个多播组，当向一个多播IP 地址发送IP分组时，该多播组内的所有成员都会收到该IP分组。
  - 工作过程：
    1. 当某个主机加人一个新的多播组时，该主机需要向多播组的多播地址发送一个IGMP报文，表明自己想要成为该多播组的成员。本地的多播路由器收到该IGMP报文后，根据多播路由协议将多播组成员信息告知Internet上的其他多播路由器。
    2. 各局域网所连接的多播路由器要周期性地探寻本地局域网上的主机，以确定这些主机是否还是某多播组的成员。





#### IPv6协议

- 由于IPv4的网络地址已被分配完毕，所以现在的网络地址逐渐使用IPv6协议

- 特点：
  - IPv6采用了新的IP首部格式，包括基本首部和多个可选的扩展首部，基本首部为固定的40B长度。
  - IPv6中将IP地址设置为**128位**（16个字节）。
- 例如一个用**冒号十六进制数**表示的IPv6地址：45EE:0000:78AC:FFFF:2A9B:0000:FFFF:62F4
- 冒号十六进制表示方法还可以采用压缩方式，对于连续的多部分0，可以利用连续的"::"代替，但在一个IPv6地址中只能用一次。比如某IPv6地址为：BC83:0000:0000:0000:0000:315A:0000:0000 压缩方式写法：BC83::315A:0000:000C
- IPv6地址包括单播地址、组播地址和任播地址3种类型。

